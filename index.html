<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>在线 JSON 模板编辑器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    script-src 'self';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data:;
    connect-src 'self';
    object-src 'none';
    base-uri 'none';
    frame-ancestors 'none';
  ">
  <style>
    body { font-family: system-ui; background:#f7f8fa; padding:16px; max-width:960px; margin:auto; }
    h1 { font-size:20px; margin-bottom:12px; }
    .box { background:#fff; padding:12px; border:1px solid #ddd; margin-bottom:12px; }
    fieldset {
      border:1px solid #ccc;
      padding:0;
      margin-bottom:12px;
      transition: all 0.3s ease;
      overflow:hidden;
    }
    fieldset legend {
      font-weight:bold; font-size:14px; cursor:pointer; user-select:none;
      background:#eee; padding:8px 10px; display:flex; justify-content:space-between; align-items:center;
    }
    fieldset .fieldset-content {
      padding:10px;
      max-height:500px;
      transition:max-height 0.3s ease, opacity 0.3s ease;
      opacity:1;
    }
    fieldset.collapsed .fieldset-content {
      max-height:0;
      opacity:0;
      padding:0 10px;
    }
    fieldset legend::after { content:'▾'; font-size:12px; }
    fieldset.collapsed legend::after { content:'▸'; }
    .field { margin-bottom:10px; }
    label { display:block; margin-bottom:4px; font-size:14px; }
    input, select { width:100%; padding:8px; font-size:16px; }
    .array-item { border:1px dashed #ccc; padding:8px; margin-bottom:8px; }
    button { padding:10px 14px; font-size:14px; margin:6px 6px 6px 0; }
    pre { background:#222; color:#0f0; padding:10px; max-height:220px; overflow:auto; font-size:12px; }
    footer { font-size:12px; color:#666; margin-top:32px; }
    @media (max-width: 600px) {
      body { padding:10px; }
      h1 { font-size:18px; }
      button { width:100%; margin-bottom:8px; }
      .box { padding:10px; }
    }
  </style>
</head>
<body>

<h1>在线 JSON 模板编辑器</h1>

<div class="box">
  <strong>说明：</strong> 本工具不会上传、存储或分析您的任何文件，所有操作均在浏览器本地完成。
</div>

<div class="box">
  <label>选择模板</label>
  <select id="templateSelect"></select>
</div>

<div class="box">
  <label>导入 JSON 文件</label>
  <input type="file" id="jsonInput" accept="application/json" />
</div>

<div class="box">
  <button onclick="expandAll()">全部展开</button>
  <button onclick="collapseAll()">全部折叠</button>
</div>

<div class="box">
  <button onclick="exportJSON()">导出 JSON</button>
</div>

<div id="form"></div>

<h3>当前 JSON（只读）</h3>
<pre id="output">{}</pre>

<footer>
  <p>© 模板化 JSON 编辑器 · 纯前端工具</p>
</footer>

<script>
const TEMPLATE_INDEX = [
  { id: 'patient', name: '患者信息模板', url: './templates/patient.json' }
];

let template = null;

const templateSelect = document.getElementById('templateSelect');
TEMPLATE_INDEX.forEach(t => {
  const opt = document.createElement('option');
  opt.value = t.url;
  opt.textContent = t.name;
  templateSelect.appendChild(opt);
});

templateSelect.onchange = () => loadTemplate(templateSelect.value);

async function loadTemplate(url) {
  const res = await fetch(url);
  template = await res.json();
  render();
}

function render() {
  const form = document.getElementById('form');
  form.innerHTML = '';
  renderFields(template, form, []);
  updateOutput();
}

function renderFields(fields, container, path) {
  for (const key in fields) {
    const field = fields[key];
    const id = [...path, key].join('.');

    if (field.type === 'object') {
      const fs = document.createElement('fieldset');
      const legend = document.createElement('legend');
      legend.textContent = field.label;
      legend.onclick = () => fs.classList.toggle('collapsed');
      fs.appendChild(legend);
      const content = document.createElement('div');
      content.className = 'fieldset-content';
      renderFields(field.fields, content, [...path, key]);
      fs.appendChild(content);
      container.appendChild(fs);
    }
    else if (field.type === 'array') {
      const fs = document.createElement('fieldset');
      const legend = document.createElement('legend');
      legend.textContent = field.label;
      legend.onclick = () => fs.classList.toggle('collapsed');
      fs.appendChild(legend);
      const content = document.createElement('div');
      content.className = 'fieldset-content';
      const list = document.createElement('div');
      content.appendChild(list);
      const btn = document.createElement('button');
      btn.textContent = '添加一项';
      btn.onclick = () => addArrayItem(field, list, [...path, key]);
      content.appendChild(btn);
      fs.appendChild(content);
      container.appendChild(fs);
    }
    else {
      container.appendChild(createInput(field, id));
    }
  }
}

function createInput(field, id) {
  const div = document.createElement('div');
  div.className = 'field';
  const label = document.createElement('label');
  label.textContent = field.label;
  div.appendChild(label);

  let input;
  if (field.type === 'boolean') {
    input = document.createElement('input'); input.type='checkbox';
  } else {
    input = document.createElement('input');
    input.type = field.type === 'number' ? 'number' : 'text';
  }
  input.id = id;
  input.oninput = updateOutput;
  div.appendChild(input);
  return div;
}

function addArrayItem(field, container, path) {
  const idx = container.children.length;
  const box = document.createElement('div');
  box.className = 'array-item';
  renderFields(field.item.fields, box, [...path, idx]);
  const del = document.createElement('button');
  del.textContent = '删除';
  del.onclick = () => { box.remove(); updateOutput(); };
  box.appendChild(del);
  container.appendChild(box);
}

function collect(fields, path=[]) {
  const obj = {};
  for (const key in fields) {
    const field = fields[key];
    if (field.type === 'object') {
      obj[key] = collect(field.fields, [...path, key]);
    }
    else if (field.type === 'array') {
      const arr = [];
      document.querySelectorAll('.array-item').forEach((box,i)=>{
        arr.push(collect(field.item.fields,[...path,key,i]));
      });
      obj[key] = arr;
    }
    else {
      const el = document.getElementById([...path,key].join('.'));
      obj[key] = field.type==='boolean' ? el.checked : el.value||null;
    }
  }
  return obj;
}

function updateOutput() {
  if (!template) return;
  const data = collect(template);
  document.getElementById('output').textContent = JSON.stringify(data,null,2);
}

function exportJSON() {
  const data = collect(template);
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'data.json';
  a.click();
}

document.getElementById('jsonInput').onchange = e => {
  const r = new FileReader();
  r.onload = ev => {
    try {
      const json = JSON.parse(ev.target.result);
      const result = fill(template, json);
      updateOutput();
      if (result.success) {
        alert('文件上传成功！');
      } else {
        alert('❌ 文件字段不匹配：\n' + result.errors.join('\n'));
      }
    } catch (err) {
      alert('❌ 文件格式不正确');
      console.error(err);
    }
  };
  r.readAsText(e.target.files[0]);
};

function fill(fields, data, path=[]) {
  let errors = [];
  let success = true;
  for (const key in fields) {
    const field = fields[key];
    const el = document.getElementById([...path, key].join('.'));
    if (field.type === 'object') {
      if (data?.[key]) {
        success = success && fill(field.fields, data?.[key], [...path, key]).success;
      } else {
        errors.push('缺少对象字段：' + [...path, key].join('.'));
        success = false;
      }
    } else if (field.type === 'array') {
      if (Array.isArray(data?.[key])) {
        data[key].forEach((item, idx) => {
          success = success && fill(field.item.fields, item, [...path, key, idx]).success;
        });
      } else {
        errors.push('缺少数组字段：' + [...path, key].join('.'));
        success = false;
      }
    } else {
      if (data?.[key] !== undefined) {
        el.value = data[key];
      } else {
        errors.push('缺少字段：' + [...path, key].join('.'));
        success = false;
      }
    }
  }
  return { success, errors };
}

loadTemplate(TEMPLATE_INDEX[0].url);

function expandAll() {
  document.querySelectorAll('fieldset').forEach(fs => fs.classList.remove('collapsed'));
}

function collapseAll() {
  document.querySelectorAll('fieldset').forEach(fs => fs.classList.add('collapsed'));
}
</script>
</body>
</html>
